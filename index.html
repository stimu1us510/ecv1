<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Document</title>
</head>
<body>

<!-- Navbar -->
<div id="nav-cont" class="">
<nav class="navbar navbar-expand-lg navbar-light mb-4" style="background-color: #e3f2fd;">
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggle" aria-controls="navbarToggle" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarToggle">
    <a class="navbar-brand" href="/"><img style="max-height:30px;" src="https://softr-prod.imgix.net/applications/b5fedfc4-cd1f-43b7-954c-60ebbf13631a/assets/8bf6e5c1-bbd5-4442-9e19-74515017980c.png"></a>
    <ul class="navbar-nav ml-auto mt-2 mt-lg-0 text-primary">
      <li class="nav-item ml-2">
        <a class="nav-link" href="/">Home</a>
      </li>
      <li class="nav-item ml-3">
        <a class="nav-link" href="#" onclick="getLockedSentences();return false;">Show All</a>    
      </li>
      <li class="nav-item ml-3">
        <a class="nav-link" href="#">Collections</a>
      </li>
      <li class="nav-item ml-3">
        <a class="nav-link" href="#" onclick="toggleHelperTools();return false;">helper tools</a>
      </li>
      <li class="nav-item ml-3 text-dark">
        <a class="nav-link" href="#" onclick="logout();return false;"> Logout <i class="bi bi-box-arrow-right"></i></a>
      </li>
    </ul>
  </div>
</nav>
</div>

<div class="d-flex justify-content-start flex-column" style="margin: auto; max-width:1200px;">

<div id="getAuth-forms"> <!-- authforms wrapper -->

<!-- signup forms -->
<div id="signup-card" class="d-flex justify-content-center mb-1 d-none auth-form">
    <div class="card">
        <div class="card-body" style="width: 400px;">
        <form id="signup-form">
            <div class="d-flex justify-content-center mt-2 mb-3"><h3>Signup</h3></div>
            <div class="form-floating mb-3">
                <input name="name" type="text" class="form-control" id="floatingInputNameSignup" placeholder="John-Doe">
                <label for="floatingInput">Name</label>
            </div>
            <div class="form-floating mb-3">
                <input name="email" type="email" class="form-control" id="floatingInputEmailSignup" placeholder="name@example.com">
                <label for="floatingInput">Email address</label>
            </div>
            <div class="form-floating mb-3">
                <input name="password" type="password" minlength="4" class="form-control" id="floatingPasswordSignup" placeholder="Password">
                <label for="floatingPassword">Password</label>
            </div>
            <div class="mt-1 mb-3">
                <button type="submit" class="btn btn-warning w-100">Signup</button>
            </div>
        </form>
        </div>  
    </div>
</div>
<div class="d-flex justify-content-center loginLink d-none">
  <span>Have an account? <a id="myLink" title="login"href="PleaseEnableJavascript.html" onclick="dispLogin();return false;">login</a></span>
</div>

<!-- login forms  -->
<div id="login-card" class="d-flex justify-content-center mb-1">
    <div class="card">
        <div class="card-body" style="width: 400px;">
        <form id="login-form">
            <div class="d-flex justify-content-center mt-2 mb-3"><h3>Login</h3></div>
            <div class="form-floating mb-3">
                <input name="email" type="email" class="form-control" id="floatingInputEmail" placeholder="name@example.com">
                <label for="floatingInput">Email address</label>
            </div>
            <div class="form-floating mb-3">
                <input name="password" type="password" minlength="4" class="form-control" id="floatingPassword" placeholder="Password">
                <label for="floatingPassword">Password</label>
            </div>
            <div class="mt-1 mb-3">
                <button type="submit" class="btn btn-warning w-100">Login</button>
            </div>
        </form>
        </div>      
    </div>
</div>
<div class="d-flex justify-content-center singupLink">
  <span>Need an account? <a id="myLink" title="singup" href="PleaseEnableJavascript.html" onclick="dispSignup();return false;">signup</a></span>
</div>
</div> <!-- authforms wrapper end -->

<!-- temp helper tools  -->
<div id="helper-tools" class="d-flex justify-content-center d-none mt-6 mb-2">
    <div class="card">
        <div class="card-body" style="width: 400px;">
        
            <button class="btn btn-warning w-100 mb-2" onclick="signup()">Signup</button>

            <button class="btn btn-warning w-100 mb-2" onclick="login()">Login</button>

            <button class="btn btn-outline-danger w-100 mb-2" onclick="logout()">Logout</button>

            <button class="btn btn-outline-dark w-100 mb-2" onclick="showKey()">See Key</button>

            <button class="btn btn-outline-dark w-100 mb-2" onclick="authMe()">Auth Me</button>

            <button class="btn btn-outline-dark w-100 mb-2" onclick="getLockedSentences()">Get Sentences</button>
            
        </div>
    </div>
</div>

<!-- welcome message   -->
<div id="welcome-alert-container" class="d-flex justify-content-center d-none">
  <div class="alert alert-warning alert-dismissible fade show d-flex justify-content-center" 
  role="alert" style="max-width: 800px;">
      <strong class="px-5">Welcome Back <span id="welcome-user">...</span>!</strong>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
</div>


<!-- user history w/score input  -->
<div id="user-history-cont" class="d-none w-100">
<!-- chart -->
<div class="d-flex justify-content-center mb-2">
  <div class="h-50 w-50">
      <canvas id="myChart"></canvas>
  </div>
</div>
<!-- total score display -->
<div id="total-score-cont" class="d-flex flex-column justify-content-center">
<h3>Your current total score for today is <span id="current-total-score">...</span> !</h3>
</div>

<!-- point entry form -->
<form id="point-form">

  <div class="form-check">
      <input class="form-check-input" type="radio" name="flexRadioDefault" value="1" id="flexRadioDefault1" required>
      <label class="form-check-label" for="flexRadioDefault1">
      Award 1 point
      </label>
  </div>
  
  <div class="form-check">
      <input class="form-check-input" type="radio" name="flexRadioDefault" value="2" id="flexRadioDefault2" required>
      <label class="form-check-label" for="flexRadioDefault2">
      Award 2 points
      </label>
  </div>
  
  <div class="form-check">
      <input class="form-check-input" type="radio" name="flexRadioDefault" value="3" id="flexRadioDefault3" required>
      <label class="form-check-label" for="flexRadioDefault3">
      Award 3 points
      </label>
  </div>
  
  <div class="form-check">
      <input class="form-check-input" type="radio" name="flexRadioDefault" value="4" id="flexRadioDefault4" required>
      <label class="form-check-label" for="flexRadioDefault4">
      Award 4 points
      </label>
  </div>
  
  <div class="form-check">
      <input class="form-check-input" type="radio" name="flexRadioDefault" value="5" id="flexRadioDefault5" required>
      <label class="form-check-label" for="flexRadioDefault5">
      Award 5 points
      </label>
  </div>

  <button type="submit" class="btn btn-primary mt-2">Submit</button>

</form>
</div>

<!-- sentences -->
<div id="sentences-container"></div>

<!-- error message to user -->
<div class="d-flex justify-content-center">
  <div id="fetching-data-loader" class="spinner-border hide" role="status"></div>
  <div id="error-message-alert" class="alert alert-dark hide" role="alert">
  <span id="error-message-text">There was a problem fetching the data.</span>
  </div>
</div>

<!-- more sentences -->
<div id="see-more-sentences-container" class="d-flex justify-content-center">
  <button id="show-more-button" class="btn btn-light hide border-1 shadow-sm">show more</button>
</div>


</div> <!-- body wrapper end -->

<style>
.mainAccord--summary {
  font-size: 1rem;
}
</style>

<script>
const signupForm = document.getElementById('signup-form')
const signupCard = document.getElementById('signup-card')
const loginForm = document.getElementById('login-form')
const loginCard = document.getElementById('login-card')
const helperTools = document.getElementById('helper-tools')
let user = ''
var helperToolsToggle = true

signupForm.addEventListener('submit', function(e) {
  e.preventDefault()

  let formData = new FormData(signupForm),
  payload = {}
  for (let entry of formData.entries()){ payload[entry[0]] = entry[1] }
  
  fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/auth/signup', {
    method: 'POST',
    headers: { 'Content-Type' : 'application/json' },
    body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
      localStorage.setItem('authkey', data.authToken)
      location.reload()
     })
    .catch((error) => {
         console.error('Error:', error)
         errorAlert("There was an error signing up")
    })
  payload = {}
})

loginForm.addEventListener('submit', function(e) {
  e.preventDefault()

  let formData = new FormData(loginForm),
  payload = {}
  for (let entry of formData.entries()){ payload[entry[0]] = entry[1] }
  
  fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/auth/login', {
    method: 'POST',
    headers: { 'Content-Type' : 'application/json' },
    body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
      console.log('Success:', data)
      localStorage.setItem('authkey', data.authToken)
      location.reload()
     })
    .catch((error) => {
         console.error('Error:', error)
         errorAlert("There was an error signing up")
    })
  payload = {}
})

function authMe2() {
fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/auth/me', {
  method: 'GET',
  headers: { 'Content-Type' : 'application/json', 'Authorization' : localStorage.getItem('authkey') }
  })
  .then(function (response) {
    if(!response.ok) {
        console.log("authErr")
        showAuthForms()
    } else {
      console.log("sucessful auth")
      hideAuthForms()
      return response.json()
    }
  })
  .then(function (data) {
    user = data.name[0].toUpperCase() + data.name.slice(1)
    setAuthDisp()
    return data.id
    })
  .catch(function (err) {
	//console.warn('Something went wrong.', err)
  })    
}

function logout() {
    localStorage.setItem('authkey', '')
    setNoAuthDisp() //reset display to pre-logged in state
    location.reload() //reload to show login screen
}

function clearSentences() {
    size = 0
    showMoreButton.classList.add('hide')
    while(sentencesContainer.hasChildNodes()) sentencesContainer.removeChild(sentencesContainer.lastChild)
}

function dispSignup() {
  loginCard.classList.add('d-none')
  document.querySelector('.loginLink').classList.remove('d-none')
  signupCard.classList.remove('d-none')
  document.querySelector('.singupLink').classList.add('d-none')
}

function dispLogin() {
  loginCard.classList.remove('d-none')
  document.querySelector('.loginLink').classList.add('d-none')
  signupCard.classList.add('d-none')
  document.querySelector('.singupLink').classList.remove('d-none')
}

function hideAuthForms() {
  document.querySelector('#getAuth-forms').classList.add('d-none')
}

function showAuthForms() {
 document.querySelector('#getAuth-forms').classList.remove('d-none')
}

function setAuthDisp() {
  document.querySelector('#user-history-cont').classList.remove('d-none')
  document.querySelector('#welcome-alert-container').classList.remove('d-none')
  document.querySelector('#welcome-user').innerHTML = user
}

function setNoAuthDisp() {
  clearSentences()
  document.querySelector('#user-history-cont').classList.add('d-none')
  document.querySelector('#welcome-alert-container').classList.add('d-none')
}

function clearSentences() {
    size = 0
    showMoreButton.classList.add('hide')
    while(sentencesContainer.hasChildNodes()) sentencesContainer.removeChild(sentencesContainer.lastChild)
}

// temp tool functions to delete int he future
function toggleHelperTools() {
  helperToolsToggle = !helperToolsToggle
  helperToolsToggle ? helperTools.classList.add('d-none') :
  helperTools.classList.remove('d-none')
}

hideAuthForms() //initial hide while waiting for authMe response
authMe2() //check if the user needs to login or not on pageload
</script>




<script>
let lablesForChartData = []
let chartData = []

  const data = {
    labels: lablesForChartData,
    datasets: [{
      label: 'points per day',
      backgroundColor: 'rgb(255, 99, 132)',
      borderColor: 'rgb(255, 99, 132)',
      data: chartData,
    }]
  };

  const config = {
    type: 'line',
    data: data,
    options: {}
  };

</script>

<script>
const pointForm = document.getElementById('point-form')
const changeToDateFormat = d => d.toJSON().slice(0,10).split('-').reverse().join('/')
const myChart = new Chart(document.getElementById('myChart'),config)

pointForm.addEventListener("submit", submitPoints)
function submitPoints(form) {
  form.preventDefault()
  let formData = new FormData(pointForm)
  let date = new Date()
  let dateToSend = date.toISOString()
  let payload = { pointsGained : formData.get('flexRadioDefault'), timeStamp : dateToSend }
  fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/user_history/{user_history_id}', {
  method: 'POST',
  headers: { 'Content-Type' : 'application/json', 'Authorization' : localStorage.getItem('authkey') },
  body: JSON.stringify(payload)
  })
  .then(function (response) {return response.json()})
  .then(function (data) {
    document.querySelector('#current-total-score').innerHTML = data
    getAllHistory()
    })
  .catch(function (err) {
	console.warn('Something went wrong.', err)
  })    
}

function getTotalScore() {
  let dateNow = Date.now()
  let postData = { timeStamp : dateNow }
  fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/user_history/{user_history_id}/get_total_score', {
  method: 'POST',
  headers: { 'Content-Type' : 'application/json', 'Authorization' : localStorage.getItem('authkey') },
  body: JSON.stringify(postData)
  })
  .then(function (response) {return response.json()})
  .then(function (data) {
    document.querySelector('#current-total-score').innerHTML = data
    })
  .catch(function (err) {
	console.warn('Something went wrong.', err)
  })   
}

function getAllHistory() {
  fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/user_history_get_all', {
    method: 'GET',
    headers: { 'Content-Type' : 'application/json', 'Authorization' : localStorage.getItem('authkey') },
  })
  .then(function (response) {return response.json()})
  .then(function (data) {
    
    myChart.config.data.datasets[0].data.length = 0
    myChart.config.data.labels.length = 0

    data.map(dataObject => {
        dataObject.created_at = new Intl.DateTimeFormat('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }).format(dataObject.created_at)
        myChart.data.labels.push(dataObject.created_at)
        myChart.config.data.datasets[0].data.push(dataObject.totalPoints)
    })
    
    myChart.update('none')

    })
  .catch(function (err) {
	console.warn('Something went wrong.', err)
  }) 
}

// -- on page load -- //

getTotalScore()
getAllHistory()
//document.querySelector('#home_header1').classList.add('d-none') // hide default softr header on the SPA page
</script>

<script>
const showMoreButton = document.getElementById('show-more-button')
const loadingSpinner = document.getElementById('fetching-data-loader')
const sentencesContainer = document.getElementById('sentences-container')
const errorMessageBox = document.getElementById('error-message-alert')
const errorMessageText = document.getElementById('error-message-text')
let size = 0
isDatafetched = false

function loadSentences() {
  
  const sentences = document.createDocumentFragment()
  fetchedData.slice(size, size+50).map(function (i, a) {
    // create card
    let card = document.createElement('div')
    card.classList.add('card')
    card.classList.add('mb-4')
    let cardBody = document.createElement('div')
    cardBody.classList.add('card-body')

    // card number
    let number = document.createElement('h4')
    number.innerHTML = `${size === 0 ? a + 1 : size + (a + 1)}`

    // make main accordian
    let mainAccord = document.createElement('details')
    let mainAccordSummary = document.createElement('summary')
    mainAccord.appendChild(mainAccordSummary)
    mainAccordSummary.innerHTML = `<span class="mainAccord--summary">${i.JpnPlain}</span>`
    
    // make first nested accordian
    let nestAccordOne = document.createElement('details')
    nestAccordOne.classList.add('nested')
    let nestAccordOneSummary = document.createElement('summary')
    nestAccordOne.innerHTML=`${i.JpnWordOrder}`
    nestAccordOne.appendChild(nestAccordOneSummary)
    nestAccordOneSummary.innerHTML = `<span class="nestAccord--summary">Word Order</span>`
    mainAccord.appendChild(nestAccordOne)
    
    // make second nested accordian
    let nestAccordTwo = document.createElement('details')
    nestAccordTwo.classList.add('nested')
    let nestAccordTwoSummary = document.createElement('summary')
    nestAccordTwo.innerHTML=`${i.EngPlain}`
    nestAccordTwo.appendChild(nestAccordTwoSummary)
    nestAccordTwoSummary.innerHTML = `<span class="nestAccord--summary">English</span>`
    mainAccord.appendChild(nestAccordTwo) 
    
    // append to body
    cardBody.appendChild(number)
    cardBody.appendChild(mainAccord)
    
    // append to body to card and card to sentences
    card.appendChild(cardBody)
    sentences.appendChild(card)
    })

  sentencesContainer.appendChild(sentences)
  size = size +50

}

showMoreButton.onclick = () => {
  loadSentences()
}

function showKey() {
    console.log(localStorage.getItem('authkey'))
    errorAlert(`This is the authkey: ${localStorage.getItem('authkey')}`)
}

function authMe() {
fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/auth/me', {
  method: 'GET',
  headers: { 'Content-Type' : 'application/json', 'Authorization' : localStorage.getItem('authkey') }
  })
  .then(function (response) {return response.json()})
  .then(function (data) {
    fetchedData = data  // JSON from our response saved as fetchedData
    console.log(data)
    })
  .catch(function (err) {
	console.warn('Something went wrong.', err)
  })    
}

function getLockedSentences() {
fetch('https://x8ki-letl-twmt.n7.xano.io/api:oZwmlDc6/sentences-with-auth', {
  method: 'GET',
  headers: { 'Content-Type' : 'application/json', 'Authorization' : localStorage.getItem('authkey') }
  })
  .then(function (response) {return response.json()})
  .then(function (data) {
    fetchedData = data  // JSON from our response saved as fetchedData
    isDatafetched = true
    showMoreButton.classList.remove('hide')
    loadingSpinner.classList.add('hide')
    loadSentences()
    console.log(data)
    })
  .catch(function (err) {
	console.warn('Something went wrong.', err)
	showMoreButton.classList.add('hide')
	errorAlert("Loggin to access this content")
  })    
}

function errorAlert(errMessage) {
    errorMessageBox.classList.remove('hide')
    errorMessageText.innerHTML = errMessage
    setTimeout(() => {
    errorMessageBox.classList.add('hide')
    }, 2000)
}

</script>
</body>
</html>
